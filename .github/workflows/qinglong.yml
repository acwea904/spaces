name: Build and Push QingLong Docker Image

on:
  push:
    branches: [ main ]  # ä¿®å¤ï¼šä½¿ç”¨æ ‡å‡†è‹±æ–‡å…³é”®è¯
    paths:
      - 'QingLong/services.json'
      - 'QingLong/notify.py'
      - 'QingLong/front.conf'
      - 'QingLong/docker-entrypoint.sh'
      - 'QingLong/README.md'
      - 'QingLong/Dockerfile'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ğŸ¯ æ ¸å¿ƒæ–°å¢ï¼šæ·±åº¦æ¸…ç†ç£ç›˜ç©ºé—´
      - name: æ¸…ç†ç£ç›˜ç©ºé—´
        run: |
          echo "=== æ¸…ç†å‰ç£ç›˜ä½¿ç”¨ ==="
          df -h
          sudo docker system prune -af --volumes || true
          sudo rm -rf /opt/hostedtoolcache/*
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo apt-get clean
          sudo apt-get autoremove -y --purge
          sudo rm -rf /var/lib/apt/lists/*
          echo "=== æ¸…ç†åç£ç›˜ä½¿ç”¨ ==="
          df -h

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: æ˜¾ç¤ºå‰©ä½™ç©ºé—´ï¼ˆè°ƒè¯•ç”¨ï¼‰
        run: |
          echo "=== Docker Buildx è®¾ç½®å ==="
          df -h
          docker buildx du

      - id: lower-repo
        shell: pwsh
        run: |
          "::set-output name=repository::$($env:GITHUB_REPOSITORY.ToLowerInvariant())"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./QingLong
          push: true
          tags: |
            ghcr.io/${{ steps.lower-repo.outputs.repository }}/zidh:latest
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.description=QingLong Docker Image
            org.opencontainers.image.licenses=MIT
          cache-from: type=gha
          cache-to: type=gha,mode=max
